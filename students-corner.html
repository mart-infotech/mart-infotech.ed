<!DOCTYPE html>
<html lang="en">
    <head>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.min.js"></script>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Mart Infotech Computers - Student Registration</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
        <style>
            .header-logo {
                max-height: 80px;
            }
            .preview-image {
                max-width: 200px;
                max-height: 200px;
                object-fit: cover;
            }
            .required-field::after {
                content: " *";
                color: red;
            }
            .student-card {
                transition: all 0.3s ease;
            }
            .student-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }
            .loading {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255,255,255,0.8);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }
            .student-photo {
                width: 200px;
                height: 200px;
                object-fit: cover;
                margin: 0 auto;
                display: block;
                border-radius: 8px;
                padding: 10px;
            }
            .delete-btn {
                margin-left: 10px;
            }
        </style>
    </head>
<body>
    <div class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                Mart Infotech Computers
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab">
                    <i class="bi bi-person-plus-fill"></i> Register Student
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="view-tab" data-bs-toggle="tab" data-bs-target="#view" type="button" role="tab">
                    <i class="bi bi-people-fill"></i> View Students
                </button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Registration Form -->
            <div class="tab-pane fade show active" id="register" role="tabpanel">
                <form id="studentForm" class="mt-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label required-field">Student Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required-field">Parentage</label>
                            <input type="text" class="form-control" name="parentage" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required-field">Date of Birth (DD/MM/YYYY)</label>
                            <input type="date" class="form-control" name="dob" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label required-field">Address</label>
                            <textarea class="form-control" name="address" required></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required-field">Aadhaar Number</label>
                            <input type="text" class="form-control" name="aadhaar" pattern="\d{12}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required-field">10th Roll Number</label>
                            <input type="text" class="form-control" name="tenth_roll" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">12th Roll Number (Optional)</label>
                            <input type="text" class="form-control" name="twelfth_roll">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Graduation Details (Optional)</label>
                            <input type="text" class="form-control" name="graduation">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required-field">Select Course</label>
                            <select class="form-select" name="course" required>
                                <option value="">Choose a course...</option>
                                <option value="CCC">CCC</option>
                                <option value="ADCA">ADCA</option>
                                <option value="FASHION_DESIGNING">Fashion Designing</option>
                                <option value="URDU_DIPLOMA">Urdu Language Diploma</option>
                                <option value="ARABIC_DIPLOMA">Arabic Language Diploma</option>
                                <option value="TALLY">Tally</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label required-field">Student Photograph</label>
                            <input type="file" class="form-control" name="photo" accept="image/*" required>
                            <img id="photoPreview" class="mt-2 preview-image d-none">
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Register Student
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- View Students -->
            <div class="tab-pane fade" id="view" role="tabpanel">
                <div class="row mt-4" id="studentsContainer">
                    <!-- Students will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Student Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <!-- Form fields will be dynamically populated -->
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="viewDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Student Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center mb-3">
                            <img id="detailsPhoto" class="img-fluid rounded student-photo" alt="Student Photo">
                        </div>
                        <div class="col-md-8">
                            <table class="table">
                                <tbody>
                                    <tr>
                                        <th>Name</th>
                                        <td id="detailsName"></td>
                                    </tr>
                                    <tr>
                                        <th>Parentage</th>
                                        <td id="detailsParentage"></td>
                                    </tr>
                                    <tr>
                                        <th>Date of Birth</th>
                                        <td id="detailsDob"></td>
                                    </tr>
                                    <tr>
                                        <th>Address</th>
                                        <td id="detailsAddress"></td>
                                    </tr>
                                    <tr>
                                        <th>Course</th>
                                        <td id="detailsCourse"></td>
                                    </tr>
                                    <tr>
                                        <th>Aadhaar Number</th>
                                        <td id="detailsAadhaar"></td>
                                    </tr>
                                    <tr>
                                        <th>10th Roll Number</th>
                                        <td id="detailsTenthRoll"></td>
                                    </tr>
                                    <tr>
                                        <th>12th Roll Number</th>
                                        <td id="detailsTwelfthRoll"></td>
                                    </tr>
                                    <tr>
                                        <th>Graduation Details</th>
                                        <td id="detailsGraduation"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button class="btn btn-primary edit-from-details" data-student-id="">
                                <i class="bi bi-pencil"></i> Edit Details
                            </button>
                            <button class="btn btn-danger ms-2 delete-from-details" data-student-id="">
                                <i class="bi bi-trash"></i> Delete Student
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <a href="index.html" class="back-link">← Back to Home</a>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
   
    <script>

        const SUPABASE_URL = 'https://dfbqeudkvurnwqaedwpy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmYnFldWRrdnVybndxYWVkd3B5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA1NTI5MjcsImV4cCI6MjA0NjEyODkyN30.XGci41s1tNmZFVkbHpYSBkFl3HNomRhBvA33RRsEAZU';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
    
        const showLoading = () => document.querySelector('.loading').style.display = 'flex';
        const hideLoading = () => document.querySelector('.loading').style.display = 'none';
    
        // Format date to DD/MM/YYYY
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

       // Helper function to get photo URL
       function getPhotoUrl(photoPath) {
        if (!photoPath) return '/api/placeholder/200/200';
        return `${SUPABASE_URL}/storage/v1/object/public/student-photos/${photoPath}`;
    }

    // Update the loadStudents function with proper photo handling
    async function loadStudents() {
        showLoading();
        try {
            const { data, error } = await supabaseClient
                .from('students')
                .select('*')
                .order('created_at', { ascending: false });
    
            if (error) throw error;
    
            const container = document.getElementById('studentsContainer');
            container.innerHTML = '';
    
            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center">
                        <p class="text-muted">No students registered yet.</p>
                    </div>
                `;
                return;
            }
    
            data.forEach(student => {
                const photoUrl = student.photo_url 
                    ? `${SUPABASE_URL}/storage/v1/object/public/student-photos/${student.photo_url}`
                    : 'https://via.placeholder.com/200x200?text=No+Photo';
        
                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4 mb-4';
                card.innerHTML = `
    <div class="card student-card h-100" style="cursor: pointer;" data-student-id="${student.id}">
        <img src="${photoUrl}" 
             class="student-photo" 
             alt="${student.name}'s Photo"
             onerror="this.src='https://via.placeholder.com/200x200?text=No+Photo'">
        <div class="card-body">
            <h5 class="card-title">${student.name}</h5>
            <p class="card-text">
                <strong>Course:</strong> ${student.course}

                <strong>Parentage:</strong> ${student.parentage}

                <strong>DOB:</strong> ${formatDate(student.dob)}

                <strong>Aadhaar:</strong> ${student.aadhaar}

                <strong>10th Roll:</strong> ${student.tenth_roll}
            </p>
            <div class="d-flex justify-content-between mt-2">
                <button class="btn btn-primary btn-sm edit-btn" data-student-id="${student.id}">
                    <i class="bi bi-pencil"></i> Edit
                </button>
                <!-- DELETE BUTTON REMOVED FROM HERE -->
            </div>
        </div>
    </div>
`;
                
                container.appendChild(card);
        
                // Add click event for the entire card
                const studentCard = card.querySelector('.student-card');
                studentCard.addEventListener('click', (e) => {
                    // Prevent triggering when clicking edit or delete buttons
                    if (!e.target.closest('.btn')) {
                        showStudentDetails(student.id);
                    }
                });
            });
        
            // Add event listeners for edit and delete buttons in the details modal
            document.querySelector('.edit-from-details').addEventListener('click', (e) => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
                modal.hide();
                editStudent(e.target.dataset.studentId);
            });
        
            document.querySelector('.delete-from-details').addEventListener('click', (e) => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
                modal.hide();
                deleteStudent(e.target.dataset.studentId);
            });
        
    
        } catch (error) {
            console.error('Error loading students:', error);
            alert('Error loading students: ' + error.message);
        } finally {
            hideLoading();
        }
    }
    async function showStudentDetails(id) {
        showLoading();
        try {
            const { data: student, error } = await supabaseClient
                .from('students')
                .select('*')
                .eq('id', id)
                .single();
    
            if (error) throw error;
    
            // Set photo
            const photoUrl = student.photo_url 
                ? `${SUPABASE_URL}/storage/v1/object/public/student-photos/${student.photo_url}`
                : 'https://via.placeholder.com/200x200?text=No+Photo';
            document.getElementById('detailsPhoto').src = photoUrl;
    
            // Set all other details
            document.getElementById('detailsName').textContent = student.name;
            document.getElementById('detailsParentage').textContent = student.parentage;
            document.getElementById('detailsDob').textContent = formatDate(student.dob);
            document.getElementById('detailsAddress').textContent = student.address;
            document.getElementById('detailsCourse').textContent = student.course;
            document.getElementById('detailsAadhaar').textContent = student.aadhaar;
            document.getElementById('detailsTenthRoll').textContent = student.tenth_roll;
            document.getElementById('detailsTwelfthRoll').textContent = student.twelfth_roll || 'Not provided';
            document.getElementById('detailsGraduation').textContent = student.graduation || 'Not provided';
    
            // Set student ID for edit and delete buttons
            document.querySelector('.edit-from-details').dataset.studentId = id;
            document.querySelector('.delete-from-details').dataset.studentId = id;
    
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('viewDetailsModal'));
            modal.show();
    
        } catch (error) {
            console.error('Error loading student details:', error);
            alert('Error loading student details: ' + error.message);
        } finally {
            hideLoading();
        }
    }
    
        // Add the delete student function
        async function deleteStudent(id) {
            if (!confirm('Are you sure you want to delete this student? This action cannot be undone.')) {
                return;
            }

            showLoading();
            try {
                // First get the student data to check for photo
                const { data: student, error: fetchError } = await supabaseClient
                    .from('students')
                    .select('photo_url')
                    .eq('id', id)
                    .single();

                if (fetchError) throw fetchError;

                // Delete photo if exists
                if (student.photo_url) {
                    const { error: storageError } = await supabaseClient.storage
                        .from('student-photos')
                        .remove([student.photo_url]);

                    if (storageError) throw storageError;
                }

                // Delete student record
                const { error: deleteError } = await supabaseClient
                    .from('students')
                    .delete()
                    .eq('id', id);

                if (deleteError) throw deleteError;

                alert('Student deleted successfully!');
                await loadStudents();

            } catch (error) {
                console.error('Error deleting student:', error);
                alert('Error deleting student: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Update the editStudent function to fix Aadhaar validation
        async function editStudent(id) {
            showLoading();
            try {
                const { data, error } = await supabaseClient
                    .from('students')
                    .select('*')
                    .eq('id', id)
                    .single();
        
                if (error) throw error;
        
                const editForm = document.getElementById('editForm');
                editForm.innerHTML = `
                    <input type="hidden" name="id" value="${data.id}">
                    <div class="mb-3">
                        <label class="form-label required-field">Student Name</label>
                        <input type="text" class="form-control" name="name" value="${data.name}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required-field">Parentage</label>
                        <input type="text" class="form-control" name="parentage" value="${data.parentage}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required-field">Date of Birth</label>
                        <input type="date" class="form-control" name="dob" value="${data.dob}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required-field">Address</label>
                        <textarea class="form-control" name="address" required>${data.address}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required-field">Aadhaar Number</label>
                        <input type="text" class="form-control" name="aadhaar" value="${data.aadhaar}" 
                               pattern="[0-9]{12}" title="Please enter exactly 12 digits" 
                               maxlength="12" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required-field">10th Roll Number</label>
                        <input type="text" class="form-control" name="tenth_roll" value="${data.tenth_roll}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">12th Roll Number</label>
                        <input type="text" class="form-control" name="twelfth_roll" value="${data.twelfth_roll || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Graduation Details</label>
                        <input type="text" class="form-control" name="graduation" value="${data.graduation || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label required-field">Course</label>
                        <select class="form-select" name="course" required>
                            <option value="CCC" ${data.course === 'CCC' ? 'selected' : ''}>CCC</option>
                            <option value="ADCA" ${data.course === 'ADCA' ? 'selected' : ''}>ADCA</option>
                            <option value="FASHION_DESIGNING" ${data.course === 'FASHION_DESIGNING' ? 'selected' : ''}>Fashion Designing</option>
                            <option value="URDU_DIPLOMA" ${data.course === 'URDU_DIPLOMA' ? 'selected' : ''}>Urdu Language Diploma</option>
                            <option value="ARABIC_DIPLOMA" ${data.course === 'ARABIC_DIPLOMA' ? 'selected' : ''}>Arabic Language Diploma</option>
                            <option value="TALLY" ${data.course === 'TALLY' ? 'selected' : ''}>Tally</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Update Photo</label>
                        <input type="file" class="form-control" name="new_photo" accept="image/*">
                        ${data.photo_url ? 
                            `<img src="${SUPABASE_URL}/storage/v1/object/public/student-photos/${data.photo_url}" 
                             class="mt-2 preview-image" alt="Current photo">` : 
                            ''}
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                `;
        
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
        
                // Handle edit form submission
                editForm.onsubmit = async (e) => {
                    e.preventDefault();
                    showLoading();
        
                    try {
                        const formData = new FormData(editForm);
                        const updateData = {
                            name: formData.get('name'),
                            parentage: formData.get('parentage'),
                            dob: formData.get('dob'),
                            address: formData.get('address'),
                            aadhaar: formData.get('aadhaar'),
                            tenth_roll: formData.get('tenth_roll'),
                            twelfth_roll: formData.get('twelfth_roll') || null,
                            graduation: formData.get('graduation') || null,
                            course: formData.get('course')
                        };
        
                        // Handle new photo if uploaded
                        const newPhoto = formData.get('new_photo');
                        if (newPhoto.size > 0) {
                            // Delete old photo if exists
                            if (data.photo_url) {
                                const { error: deleteError } = await supabaseClient.storage
                                    .from('student-photos')
                                    .remove([data.photo_url]);
                                    
                                if (deleteError) throw deleteError;
                            }
        
                            // Upload new photo
                            const photoName = `${Date.now()}-${newPhoto.name}`;
                            const { data: photoData, error: photoError } = await supabaseClient.storage
                                .from('student-photos')
                                .upload(photoName, newPhoto);
        
                            if (photoError) throw photoError;
                            updateData.photo_url = photoData.path;
                        }
        
                        const { error: updateError } = await supabaseClient
                            .from('students')
                            .update(updateData)
                            .eq('id', data.id);
        
                        if (updateError) throw updateError;
        
                        modal.hide();
                        await loadStudents();
                        alert('Student details updated successfully!');
        
                    } catch (error) {
                        console.error('Error updating student:', error);
                        alert('Error updating student: ' + error.message);
                    } finally {
                        hideLoading();
                    }
                };
        
            } catch (error) {
                console.error('Error loading student for edit:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        document.getElementById('studentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            showLoading();
    
            try {
                const formData = new FormData(this);
                const photoFile = formData.get('photo');
                let photoPath = null;
    
                // Upload photo
                if (photoFile.size > 0) {
                    const photoName = `${Date.now()}-${photoFile.name}`;
                    const { data: photoData, error: photoError } = await supabaseClient.storage
                        .from('student-photos')
                        .upload(photoName, photoFile);
    
                    if (photoError) throw photoError;
                    photoPath = photoData.path;
                }
    
                // Create student record
                const studentData = {
                    name: formData.get('name'),
                    parentage: formData.get('parentage'),
                    dob: formData.get('dob'),
                    address: formData.get('address'),
                    aadhaar: formData.get('aadhaar'),
                    tenth_roll: formData.get('tenth_roll'),
                    twelfth_roll: formData.get('twelfth_roll') || null,
                    graduation: formData.get('graduation') || null,
                    course: formData.get('course'),
                    photo_url: photoPath,
                    created_at: new Date().toISOString()
                };
    
                const { error } = await supabaseClient
                    .from('students')
                    .insert([studentData]);
    
                if (error) throw error;

                alert('Student registered successfully!');
                this.reset();
                document.getElementById('photoPreview').classList.add('d-none');
                
                // Switch to view tab and load students
                const viewTab = document.getElementById('view-tab');
                const tab = new bootstrap.Tab(viewTab);
                tab.show();
                await loadStudents();

            } catch (error) {
                console.error('Error registering student:', error);
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        // Preview uploaded photo in registration form
        document.querySelector('input[name="photo"]').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('photoPreview');
                    preview.src = e.target.result;
                    preview.classList.remove('d-none');
                }
                reader.readAsDataURL(file);
            }
        });

        // Load students when view tab is clicked
        document.getElementById('view-tab').addEventListener('click', loadStudents);

        // Initial load of students
        document.addEventListener('DOMContentLoaded', () => {
            // Load students if we're on the view tab
            if (document.getElementById('view-tab').classList.contains('active')) {
                loadStudents();
            }
        });
    </script>
</body>
</html>
